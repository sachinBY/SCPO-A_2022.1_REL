
DEFINE SCHEMAOWNER = 'CONNECT_MS.';

CREATE TABLE &SCHEMAOWNER.MS_SRVC 
( 
	 SRVC_ID NUMBER (5) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
	 D_DUP_KEY VARCHAR2 (255) NOT NULL , 
	 SRVC_TYPE VARCHAR2 (255) NOT NULL,
	 SRVC_NAME VARCHAR2 (255) NOT NULL,
	 SRVC_VER VARCHAR2 (255) , 
     SRVC_INST VARCHAR2 (255) NOT NULL , 
     SRVC_HOST VARCHAR2 (255) 
);

COMMENT ON TABLE &SCHEMAOWNER.MS_SRVC IS
    'Table that holds information about Services associated Messages';
	
ALTER TABLE &SCHEMAOWNER.MS_SRVC ADD CONSTRAINT MS_SRVC_ID_PK PRIMARY KEY (SRVC_ID);

ALTER TABLE &SCHEMAOWNER.MS_SRVC ADD CONSTRAINT MS_SVC_DDUP_UK UNIQUE ( D_DUP_KEY );

CREATE TABLE &SCHEMAOWNER.MS_MSG_BDY 
(
    MSG_BDY_ID   NUMBER(19) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
    CRTD_AT      TIMESTAMP NOT NULL,
	LST_UPDT_AT  TIMESTAMP NOT NULL , 
    MSG_FRMT     VARCHAR2(64) NOT NULL,
	D_DUP_KEY    VARCHAR2 (255) NOT NULL, 
    MSG_BDY      BLOB NOT NULL,
	ACTIVE       NUMBER(1) DEFAULT 1
);

COMMENT ON TABLE &SCHEMAOWNER.MS_MSG_BDY IS
    'Table that saves the  body of a  Message';

ALTER TABLE &SCHEMAOWNER.MS_MSG_BDY ADD CONSTRAINT MSG_BDY_ID_PK PRIMARY KEY ( MSG_BDY_ID );

ALTER TABLE &SCHEMAOWNER.MS_MSG_BDY ADD CONSTRAINT MS_BDY_DDUP_UK UNIQUE ( D_DUP_KEY, ACTIVE );


CREATE TABLE &SCHEMAOWNER.MS_MSG_EVNT 
(
    MSG_EVNT_ID   NUMBER(19) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
    CRTD_AT       TIMESTAMP NOT NULL,
    MSG_HDR_ID    NUMBER(19) NOT NULL,
    STATUS        VARCHAR2(64) NOT NULL,
	TASK_ID       VARCHAR2(255),
	TASK_NAME     VARCHAR2(255),
	ERR_CAT       VARCHAR2(20),
	ERR_REASON    VARCHAR2(50),
    ERR_CODE      VARCHAR2(40),
    ERR_DESC      VARCHAR2(1000),
	ERR_DETAIL_DESC VARCHAR2(2000)
);

COMMENT ON TABLE &SCHEMAOWNER.MS_MSG_EVNT IS
    'Table which contains events associated with a Message';

ALTER TABLE &SCHEMAOWNER.MS_MSG_EVNT ADD CONSTRAINT MSG_EVNT_ID_PK PRIMARY KEY ( MSG_EVNT_ID );

-- ALTER TABLE &SCHEMAOWNER.MS_MSG_EVNT ADD CONSTRAINT MS_EVNT_HDR_CRTD_UK UNIQUE (MSG_HDR_ID, CRTD_AT);

CREATE TABLE &SCHEMAOWNER.MS_MSG_HDR 
(
    MSG_HDR_ID     NUMBER(19) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
	MSG_BDY_ID     NUMBER(19) NOT NULL,
	SRVC_ID        NUMBER(5) NOT NULL ,
    CRTD_AT        TIMESTAMP NOT NULL,
    LST_UPDT_AT    TIMESTAMP NOT NULL,
    CRNT_STATUS    VARCHAR2(255),
    D_DUP_KEY      VARCHAR2(255) NOT NULL,
    END_PNT_TYPE   VARCHAR2(255) NOT NULL,
    END_PNT_NAME   VARCHAR2(255) NOT NULL,
    MDL_TYPE       VARCHAR2(255) NOT NULL,
    MSG_CAT        VARCHAR2(255) NOT NULL,
    MSG_TYPE       VARCHAR2(255) NOT NULL,
    MSG_VER        VARCHAR2(255) NOT NULL,
    MSG_ID         VARCHAR2(255) NOT NULL,
    MSG_SNDR       VARCHAR2(255),
    MSG_RCVRS      VARCHAR2(255),
    DOC_ID         VARCHAR2(255),
    DOC_CUST_ID    VARCHAR2(255),
    DOC_TMSTMP     TIMESTAMP,
    REF_MSG_SNDR   VARCHAR2(255),
    REF_MSG_ID     VARCHAR2(255),
    REF_DOC_ID     VARCHAR2(255),
    TST_MSG        NUMBER(1) DEFAULT 0,
	ACTIVE         NUMBER(1) DEFAULT 1
);

COMMENT ON TABLE &SCHEMAOWNER.MS_MSG_HDR IS
    'Table that saves Header level information associated to a Message';

ALTER TABLE &SCHEMAOWNER.MS_MSG_HDR ADD CONSTRAINT MSG_HDR_ID_PK PRIMARY KEY ( MSG_HDR_ID );

ALTER TABLE &SCHEMAOWNER.MS_MSG_HDR ADD CONSTRAINT MSG_HDR_DDUP_UK UNIQUE ( D_DUP_KEY );

ALTER TABLE &SCHEMAOWNER.MS_MSG_HDR ADD CONSTRAINT MS_HDR_SRVC_SRVID_FK FOREIGN KEY ( SRVC_ID ) REFERENCES &SCHEMAOWNER.MS_SRVC ( SRVC_ID );

ALTER TABLE &SCHEMAOWNER.MS_MSG_HDR ADD CONSTRAINT MSG_HDR_BDY_ID_FK FOREIGN KEY ( MSG_BDY_ID ) REFERENCES &SCHEMAOWNER.MS_MSG_BDY ( MSG_BDY_ID );

ALTER TABLE &SCHEMAOWNER.MS_MSG_EVNT ADD CONSTRAINT MS_EVENT_HDR_HDRID_FK FOREIGN KEY ( MSG_HDR_ID ) REFERENCES &SCHEMAOWNER.MS_MSG_HDR ( MSG_HDR_ID );

CREATE TABLE &SCHEMAOWNER.MS_BLK_HDR 
(
    BLK_HDR_ID     NUMBER(19) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
    CRTD_AT        TIMESTAMP NOT NULL,
    LST_UPDT_AT    TIMESTAMP NOT NULL,
    CRNT_STATUS    VARCHAR2(64),
	SRVC_ID        NUMBER(5) NOT NULL , 
    END_PNT_TYPE   VARCHAR2(255) NOT NULL,
    END_PNT_NAME   VARCHAR2(255) NOT NULL,
    MDL_TYPE       VARCHAR2(255) NOT NULL,
    BLK_ID         VARCHAR2(255) NOT NULL,
    BLK_TYPE       VARCHAR2(255) NOT NULL,
    BLK_VER        VARCHAR2(255) NOT NULL,
    BLK_SRC        VARCHAR2(255) NOT NULL,
    BLK_LOC        VARCHAR2(255) NOT NULL,
    BLK_FORMAT     VARCHAR2(255) NOT NULL,
    BLK_SRC_ID     VARCHAR2(255)
);

COMMENT ON TABLE &SCHEMAOWNER.MS_BLK_HDR IS
    'Table that holds Bulk level Message Header information.';

ALTER TABLE &SCHEMAOWNER.MS_BLK_HDR ADD CONSTRAINT BLK_HDR_ID_PK PRIMARY KEY ( BLK_HDR_ID );

ALTER TABLE &SCHEMAOWNER.MS_MSG_HDR ADD CONSTRAINT MS_BLK_HDR_SRVC_SRVID_FK FOREIGN KEY ( SRVC_ID ) REFERENCES &SCHEMAOWNER.MS_SRVC ( SRVC_ID );

ALTER TABLE &SCHEMAOWNER.MS_BLK_HDR ADD CONSTRAINT BLK_HDR_DTLS_UK UNIQUE ( SRVC_ID, BLK_SRC, BLK_ID );


CREATE TABLE &SCHEMAOWNER.MS_BLK_EVNT 
(
    BLK_EVNT_ID   NUMBER(19) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
    BLK_HDR_ID    NUMBER(19) NOT NULL,
    STATUS        VARCHAR2(64) NOT NULL,
    CRTD_AT       TIMESTAMP NOT NULL,    
    BTCH_ID       VARCHAR2(255),
    BTCH_TASK     VARCHAR2(255),
    BTCH_TOT_REC  NUMBER(19),
    BTCH_PRC_REC  NUMBER(19),
    BTCH_SUC_REC  NUMBER(19),
    BTCH_FLD_REC  NUMBER(19),    
    ERR_CODE      VARCHAR2(64),
    ERR_DESC      VARCHAR2(1024),
	ERR_CAT       VARCHAR2(20),
	ERR_REASON    VARCHAR2(50),
	ERR_DETAIL_DESC VARCHAR2(2000)
);

COMMENT ON TABLE &SCHEMAOWNER.MS_BLK_EVNT IS
    'Table that holds information about  events associated with  Bulk Messages';

-- ALTER TABLE &SCHEMAOWNER.MS_BLK_EVNT ADD CONSTRAINT BLK_EVNT_ID_UK UNIQUE ( BLK_EVNT_ID );

-- ALTER TABLE &SCHEMAOWNER.MS_BLK_EVNT ADD CONSTRAINT BLK_EVNT_HDR_ID_PK PRIMARY KEY (BLK_HDR_ID, CRTD_AT);

ALTER TABLE &SCHEMAOWNER.MS_BLK_EVNT ADD CONSTRAINT BLK_EVNT_ID_PK PRIMARY KEY ( BLK_EVNT_ID );

ALTER TABLE &SCHEMAOWNER.MS_BLK_EVNT ADD CONSTRAINT BLK_EVENT_HDR_HDRID_FK FOREIGN KEY ( BLK_HDR_ID ) REFERENCES &SCHEMAOWNER.MS_BLK_HDR ( BLK_HDR_ID );


CREATE TABLE &SCHEMAOWNER.MS_RCRD_HDR 
(
    BLK_RCRD_HDR_ID   NUMBER(19) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
    BLK_HDR_ID        NUMBER(19) NOT NULL,
    CRTD_AT           TIMESTAMP NOT NULL,
    LST_UPDT_AT       TIMESTAMP NOT NULL,
    LST_TASK          VARCHAR2(255),    
    CRNT_STATUS       VARCHAR2(64) NOT NULL,
    RCRD_ID           VARCHAR2(255) NOT NULL,
    SEQ_NO            NUMBER(19) NOT NULL,
    RCRD_HDR_BODY     BLOB 
);


COMMENT ON TABLE &SCHEMAOWNER.MS_RCRD_HDR IS
    'Table that saves  Record level information. A bulk is made of one or more records';

ALTER TABLE &SCHEMAOWNER.MS_RCRD_HDR ADD CONSTRAINT BLK_HDR_RCRD_HDR_ID_PK PRIMARY KEY ( BLK_HDR_ID, BLK_RCRD_HDR_ID );

ALTER TABLE &SCHEMAOWNER.MS_RCRD_HDR ADD CONSTRAINT BLK_RCRD_HDR_ID_UK UNIQUE ( BLK_RCRD_HDR_ID );

ALTER TABLE &SCHEMAOWNER.MS_RCRD_HDR ADD CONSTRAINT BLK_HDR_CRTD_AT_UK UNIQUE (BLK_HDR_ID, RCRD_ID);

ALTER TABLE &SCHEMAOWNER.MS_RCRD_HDR ADD CONSTRAINT BLK_RCRD_HDRID_FK FOREIGN KEY ( BLK_HDR_ID ) REFERENCES &SCHEMAOWNER.MS_BLK_HDR ( BLK_HDR_ID );


CREATE TABLE &SCHEMAOWNER.MS_RCRD_EVNT 
(
    BLK_RCRD_EVNT_ID   NUMBER(19) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
    RCRD_HDR_ID        NUMBER(19) NOT NULL,
	BLK_HDR_ID         NUMBER(19) NOT NULL , 
    TASK_NAME          VARCHAR2(255),
    TASK_ID            VARCHAR2(255),
    STATUS             VARCHAR2(64) NOT NULL,
    CRTD_AT            TIMESTAMP NOT NULL,
    ERR_CODE           VARCHAR2(40),
    ERR_DESC           VARCHAR2(1000),
	ERR_CAT            VARCHAR2(20),
	ERR_REASON         VARCHAR2(50),
	ERR_DETAIL_DESC    VARCHAR2(2000)
	 
);

COMMENT ON TABLE &SCHEMAOWNER.MS_RCRD_EVNT IS
    'Table that saves information about events associated with a Record';
	
ALTER TABLE &SCHEMAOWNER.MS_RCRD_EVNT ADD CONSTRAINT BLK_RCRD_EVNT_ID_UK UNIQUE (BLK_RCRD_EVNT_ID);

ALTER TABLE &SCHEMAOWNER.MS_RCRD_EVNT ADD CONSTRAINT BLK_RCRD_EVNT_ID_PK PRIMARY KEY ( BLK_HDR_ID, RCRD_HDR_ID, CRTD_AT );

ALTER TABLE &SCHEMAOWNER.MS_RCRD_EVNT ADD CONSTRAINT BLK_RCRDHDR_ID_FK FOREIGN KEY ( RCRD_HDR_ID ) REFERENCES &SCHEMAOWNER.MS_RCRD_HDR ( BLK_RCRD_HDR_ID );

ALTER TABLE &SCHEMAOWNER.MS_RCRD_EVNT ADD CONSTRAINT BLK_RCRD_EVNT_ID_FK FOREIGN KEY (BLK_HDR_ID,RCRD_HDR_ID) REFERENCES &SCHEMAOWNER.MS_RCRD_HDR ( BLK_HDR_ID, BLK_RCRD_HDR_ID );


CREATE TABLE &SCHEMAOWNER.MS_VER 
(
    VER       VARCHAR2(255) NOT NULL,
    CRTD_AT   TIMESTAMP NOT NULL,
	PATCH_VER NUMBER(5) DEFAULT 0
);


COMMENT ON TABLE &SCHEMAOWNER.MS_VER IS
    'Table to save schema version information';

ALTER TABLE &SCHEMAOWNER.MS_VER ADD CONSTRAINT MSG_VER_UK UNIQUE ( VER );

/*
Add current version
*/
INSERT INTO &SCHEMAOWNER.MS_VER(VER, CRTD_AT, PATCH_VER) VALUES('2021.2.0', CURRENT_TIMESTAMP, 0);
COMMIT;

/*
   Create replayable messages schema 
*/
CREATE TABLE &SCHEMAOWNER.MS_RPLYBL_MSGS 
(
    CRTD_AT        TIMESTAMP NOT NULL,
    LST_UPDT_AT    TIMESTAMP NOT NULL,
    MSG_STORE_ID   NUMERIC(19) NOT NULL,
	RPLY_COUNT     NUMBER(5) DEFAULT 0,
	NXT_RUN_AT     TIMESTAMP NOT NULL,
	ACTIVE         NUMBER(1) DEFAULT 1,
	RPLYNG         NUMBER(1) DEFAULT 0
);

COMMENT ON TABLE &SCHEMAOWNER.MS_RPLYBL_MSGS IS
    'Table that saves Replay level information associated to a Message';

ALTER TABLE &SCHEMAOWNER.MS_RPLYBL_MSGS ADD CONSTRAINT RPLYBL_MSG_ID_PK PRIMARY KEY ( MSG_STORE_ID );

ALTER TABLE &SCHEMAOWNER.MS_RPLYBL_MSGS ADD CONSTRAINT RPLYBL_MSGS_HDR_ID_FK FOREIGN KEY ( MSG_STORE_ID ) REFERENCES &SCHEMAOWNER.MS_MSG_HDR ( MSG_HDR_ID );


/*
   Create bulk ingestion related schema 
*/
CREATE TABLE &SCHEMAOWNER.MS_INGSTN_RCRD 
(
    INGSTN_RCRD_ID  NUMBER(16) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
    CRTD_AT        TIMESTAMP NOT NULL,
    SRVC_NAME      VARCHAR2(255) NOT NULL,
    SRVC_INST      VARCHAR2(255),
	BULK_ID		   VARCHAR2(255) NOT NULL,
    BLK_LOC        VARCHAR2(255) NOT NULL    
);

COMMENT ON TABLE &SCHEMAOWNER.MS_INGSTN_RCRD IS
    'Table that saves bulk ingestion records';

ALTER TABLE &SCHEMAOWNER.MS_INGSTN_RCRD ADD CONSTRAINT INGSTN_RCRD_ID_PK PRIMARY KEY ( INGSTN_RCRD_ID );

ALTER TABLE &SCHEMAOWNER.MS_INGSTN_RCRD ADD CONSTRAINT INGSTN_RCRD_UK UNIQUE ( SRVC_NAME, BULK_ID );

CREATE TABLE &SCHEMAOWNER.MS_BLK_INGSTN 
(
    BLK_INGSTN_ID  NUMBER(16) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
    LST_INGSTD_AT  TIMESTAMP NOT NULL,
    BLK_INGSTN_RCRD_ID        NUMBER(16) NOT NULL,
    ING_SRVC_NAME      VARCHAR2(255) NOT NULL,
    CUR_POS            NUMBER(16) NOT NULL    
);

COMMENT ON TABLE &SCHEMAOWNER.MS_BLK_INGSTN IS
    'Table that keeps track of the bulk ingestions';

ALTER TABLE &SCHEMAOWNER.MS_BLK_INGSTN ADD CONSTRAINT BLK_INGSTN_ID_PK PRIMARY KEY ( BLK_INGSTN_ID );

ALTER TABLE &SCHEMAOWNER.MS_BLK_INGSTN ADD CONSTRAINT BLK_INGSTN_UK UNIQUE ( BLK_INGSTN_RCRD_ID, ING_SRVC_NAME );

ALTER TABLE &SCHEMAOWNER.MS_BLK_INGSTN ADD CONSTRAINT MS_BULK_INGSTN_FK FOREIGN KEY ( BLK_INGSTN_RCRD_ID ) REFERENCES &SCHEMAOWNER.MS_INGSTN_RCRD ( INGSTN_RCRD_ID ) ON DELETE CASCADE;

CREATE TABLE &SCHEMAOWNER.MS_BLK_INGSTN_EVNT 
(
    BLK_INGSTN_EVNT_ID        NUMERIC(16) GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
	BLK_INGSTN_ID        NUMERIC(16) NOT NULL,
    INGSTD_AT  TIMESTAMP NOT NULL,
    ING_SRVC_INST      VARCHAR2(255),    
    STRT_POS       NUMBER(16) NOT NULL,
    END_POS       NUMBER(16) NOT NULL
);

COMMENT ON TABLE &SCHEMAOWNER.MS_BLK_INGSTN_EVNT IS
    'Table that captures the ingestion events of a service';

ALTER TABLE &SCHEMAOWNER.MS_BLK_INGSTN_EVNT ADD CONSTRAINT MS_BULK_INGSTN_EVNT_FK FOREIGN KEY ( BLK_INGSTN_ID ) REFERENCES &SCHEMAOWNER.MS_BLK_INGSTN ( BLK_INGSTN_ID ) ON DELETE CASCADE;

/*
   Create user data related schema 
*/

CREATE TABLE &SCHEMAOWNER.MS_USER_DATA
(
	USER_ID		VARCHAR2(255)	PRIMARY KEY ,
	USER_DATA	VARCHAR2(4000)	NOT NULL ,
	CREATED_AT	TIMESTAMP		NOT NULL
);

/*
   Create message tagging schema
*/

CREATE TABLE &SCHEMAOWNER.MS_TAG
(
    TAG_ID      NUMERIC(5)     GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 NOCACHE ) NOT NULL,
	TAG_NAME    VARCHAR2(255)   NOT NULL,
    CREATED_AT  TIMESTAMP       NOT NULL
);

ALTER TABLE &SCHEMAOWNER.MS_TAG ADD CONSTRAINT TAG_ID_PK PRIMARY KEY ( TAG_ID );

ALTER TABLE &SCHEMAOWNER.MS_TAG ADD CONSTRAINT TAG_UK UNIQUE ( TAG_NAME );

COMMENT ON TABLE &SCHEMAOWNER.MS_TAG IS
    'Table that maintains tags for grouping messages';

CREATE TABLE &SCHEMAOWNER.MS_MSG_TAG
(
	TAG_ID          NUMERIC(5) NOT NULL,
	MSG_HDR_ID      NUMERIC(16) NOT NULL,
    CREATED_AT      TIMESTAMP   NOT NULL
);


ALTER TABLE &SCHEMAOWNER.MS_MSG_TAG ADD CONSTRAINT TAG_FK FOREIGN KEY ( TAG_ID ) REFERENCES &SCHEMAOWNER.MS_TAG ( TAG_ID );

ALTER TABLE &SCHEMAOWNER.MS_MSG_TAG ADD CONSTRAINT MSG_HDR_FK FOREIGN KEY (MSG_HDR_ID ) REFERENCES &SCHEMAOWNER.MS_MSG_HDR ( MSG_HDR_ID );

COMMENT ON TABLE &SCHEMAOWNER.MS_MSG_TAG IS
    'Table that assigns messages to tag';